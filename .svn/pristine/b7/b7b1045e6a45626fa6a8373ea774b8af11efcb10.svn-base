<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport"
	content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<title>中国自动化学会机器人竞赛现场确认</title>
<script src="../static/js/jquery-3.2.1.min.js"></script>
<script type="text/javascript"
	src="http://api.map.baidu.com/api?v=2.0&ak=AGAbaV2PSZmU2lpjqlpWjonoLuf4Rn9b"></script>
<style type="text/css">
body, html {
	width: 100%;
	height: 100%;
	margin: 0;
	font-family: "微软雅黑";
}
ul,li{
	margin:0;
	padding:0;
	list-style:none;
}
#allmap {
	height: 28.1rem;
	width: 100%;
}

#blackdiv {
	position: fixed;
	width: 100%;
	height: 100%;
	top: 28.1rem;
	background: rgba(0, 0, 0, 0.7);
}

#blackdiv_matchname {
	width: 34rem;
	height: 3.8rem;
	margin: 0 auto;
	margin-top: 1.5rem;
	margin-bottom: 1rem;
	background: #FFF;
	border-radius: 0.4rem;
	text-align: center;
}

#blackdiv_matchname_font {
	line-height: 3.8rem;
	font-size: 1.4rem;
	color: #333;
}

#blackdiv_input {
	width: 34rem;
	height: 13.7rem;
	margin: 0 auto;
	background: #FFF;
	border-radius: 0.4rem;
}

#blackdiv input {
	display: block;
	height: 1.4rem;
	margin: 0 auto;
	border-left: 0;
	border-right: 0;
	border-radius: 0;
	font-size: 1.4rem;
	padding-left: 3rem;
	padding-top: 1.55rem;
	padding-bottom: 1.55rem;
}

#blackdiv_didtype {
	padding: 0;
	border-top: 0;
	border-bottom: 0.1rem solid #CCC;
	background: url(../images/didtype.png) no-repeat 0.8rem;
	width: 27.6rem;

}

#blackdiv_did {
	padding: 0;
	border-top: 0;
	border-bottom: 0.1rem solid #CCC;
	background: url(../images/did.png) no-repeat 0.8rem;
	width: 27.6rem;
	
}

#blackdiv_code {
	padding: 0;
	border-top: 0;
	border-bottom: 0;
	background: url(../images/code.png) no-repeat 0.9rem;
	padding-right: 10rem;
	width: 17.6rem;

}

#blackdiv_code_huoqu {
	user-select: none;
	position: absolute;
	top: 0.75rem;
	right: 1.7rem;
	height: 3rem;
	width: 10rem;
	border-radius: 1.5rem;
	background: #E21230;
	text-align: center;
	line-height: 3rem;
	color: #FFF;
	font-size: 1.4rem;
	cursor: pointer;
}

#blackdiv_prompt {
	width: 34rem;
	height: 4.5rem;
	margin: 0 auto;
	margin-top: 0.5rem;
	font-size: 1.2rem;
	color: #FFF;
	display:none;
}

#blackdiv_determine {
	display: block;
	width: 34rem;
	height: 3.8rem;
	margin: 0 auto;
	background: #B3B3B3;
	font-size: 1.6rem;
	color: #FFF;
	text-align: center;
	line-height: 3.8rem;
	border-radius: 1.9rem;
	margin-top:1rem;
}
#cover{
	display:none;
	position:fixed;
	width:100%;
	height:100%;
	z-index:3;
	background: rgba(0, 0, 0, 0.7);
	top:0;
}
.opbox{
	padding:1.3rem 1rem;
	display:none;
	position:fixed;
	height:14rem;
	z-index:5;
	background: #fff;
	top:40%;
	left:50%;
	margin-top:-7rem;
	margin-left:-17rem;
	width:34rem;
	box-sizing:border-box;
	border-radius: 0.4rem;
}
.btnwrap{
	overflow:hidden;
}
.cancel{
	float:left;
	color:#999;
	font-size:1.5rem;
}
.ensure{
	float:right;
	color:#e21230;
	font-size:1.5rem;
}
.opul li{
	font-size:1.5rem;
	height:3.5rem;
	line-height:3.5rem;
	text-align:center;
	border-bottom:0.1rem solid #eee;
	margin:0 2rem;
}
.cover2{
	position:fixed;
	width:100%;
	height:100%;
	z-index:3;
	background: rgba(0, 0, 0, 0.7);
	top:0;
}
.msgbox{
	position:fixed;
    z-index:5;
    width:34rem;
    min-height:15rem;
	background: #fff;
	border-radius: 0.4rem;
	padding: 3rem 2rem;
	top:50%;
	left:50%;
	margin-left:-17rem;
	margin-top:-7.5rem;
	text-align:center;
	box-sizing:border-box;
}
.wTitle{
	font-size:1.6rem;
	color: #333;
	text-align: center;
	font-weight: bold;
	margin: 0;
	margin-bottom:1rem;
}
.known,.known:hover{
	display:block;
	width:28rem;
	height:4rem;
	line-height:4rem;
	border:0.1rem solid #ccc;
	color:#fff;
	text-align:center;
	cursor:pointer;
	margin:0 auto;
	border-radius:0.4rem;
	text-decoration:none;
	font-size:1.6rem;
	background:#52ADE7;
	margin-top:2rem
}
</style>
<title>现场确认</title>
</head>
<body>
	<div id="allmap"></div>
	<div id="blackdiv">
		<div id="blackdiv_matchname">
			<img src="../images/saishi.png" style="margin-right:0.5rem" /><span
				id="blackdiv_matchname_font"></span>
		</div>
		<div id="blackdiv_input">
			<input id="blackdiv_didtype" type="text" readonly   onfocus="this.blur()" placeholder="请选择证件类型" altvalue=""/>
			<input id="blackdiv_did" type="text" placeholder="请输入证件号" />
			<!-- <div style="position:relative">
				<input id="blackdiv_code" type="text" placeholder="请输入验证码" /> <a
					id="blackdiv_code_huoqu" onclick="sendCheckCodeEmail()">获取验证码</a>
			</div> -->
		</div>
		<!-- <div id="blackdiv_prompt">已经向您的邮箱<span>2671344202@qq.com</span>发送了一封验证码邮件，请登录您的邮箱进行查看!</div> -->
		<a id="blackdiv_determine">现场确认</a>
	</div>
	<div id="cover"></div>
	<div class="opbox">
		
		<ul class="opul">
			<li altvalue="00">身份证</li>
			<li altvalue="01">护照</li>
			<li altvalue="02">港澳台通行证</li>
		</ul>
	</div>
</body>
</html>
<script type="text/javascript">
	var email="";
	var tmid="";
		$("#blackdiv_prompt span").text(email);
					$("#blackdiv_prompt").show();
					$("#blackdiv_determine").attr("onclick","siteConfirmNew()");
					$("#blackdiv_determine").css("background","#e21230");
	function sendCheckCodeEmail(){
		if(distance>20000){
			alertMsg("您距离确认点还有"+distance+"米，该位置不再现场确认20000米范围内，请到指定区域再进行现场确认！")
			return;
		}
		var didtype=$("#blackdiv_didtype").attr("altvalue");
		var did=$("#blackdiv_did").val();
		$.ajax({
			type : "POST",
			url : "../sendCheckCodeEmail",
			async : "false",
			dataType : "json",
			data : {
				didtype : didtype,
				did : did
			},
			success : function(data) {
				if (data.status == 0) {
					email = data.info.email;
					tmid = data.info.tmid;
					$("#blackdiv_prompt span").text(email);
					$("#blackdiv_prompt").show();
					$("#blackdiv_determine").attr("onclick","siteConfirm()");
					$("#blackdiv_determine").css("background","#e21230")
				} else {
					alertMsg(data.errmsg);
				}
			},
			error : function(data) {
			alertMsg(data.errmsg+'111111');
			}
		});
	}
	
	/* 屏幕适配 */
	(function (win, doc) {
            var rem = 10 / 375 * doc.documentElement.clientWidth;
            doc.documentElement.style.fontSize = rem + 'px';
            win.onresize = function () {
                rem = 10 / 375 * doc.documentElement.clientWidth;
                doc.documentElement.style.fontSize = rem + 'px';
            };
        })(window, document);   
	$(function(){
		$("#blackdiv_didtype").click(function(e){
			e.stopPropagation();
			$("#cover,.opbox").show();
		})
		$(".opul li").click(function(){
			$("#blackdiv_didtype").attr("altvalue",$(this).attr("altvalue"))
			$("#blackdiv_didtype").val($(this).text());
			hideopbox();
		})
		$(document).click(function(){
			hideopbox()
		})
		
	})
	function hideopbox(){
		$("#cover,.opbox").hide();
	}
	
	function alertMsg(text){
		var htmls="";
		htmls+='<div class="cover2"></div><div class="msgbox">'
		htmls+='<h1 class="wTitle">提示</h1>'
	    		+'<h1 class="wTitle" style="font-weight:normal">'+text+'</h1>'
	    		+'<a class="known" onclick="closeWin()">知道了</a></div>';
	    $("body").append(htmls);
	}
	function closeWin(){
		$(".cover2").remove();
		$(".msgbox").remove();
	}
	function siteConfirmNew(){
		if(distance>20000){
			alertMsg("您距离确认点还有"+distance+"米，该位置不再现场确认20000米范围内，请到指定区域再进行现场确认！")
			return;
		}
		var didtype=$("#blackdiv_didtype").attr("altvalue");
		var did=$("#blackdiv_did").val();
		$.ajax({
			type : "POST",
			url : "../signOnSiteNew",
			async : "false",
			dataType : "json",
			data : {
				"didtype" : didtype,
				"did" : did,
			},
			success : function(data) {
				if (data.status == 0) {
					alertMsg("确认成功！")
				} else {
					alertMsg(data.errmsg);
				}
			},
			error : function() {
			}
		});
	}
	function siteConfirm(){
		var checkcode=$("#blackdiv_code").val();
		$.ajax({
			type : "POST",
			url : "../signOnSite",
			async : "false",
			dataType : "json",
			data : {
				"email" : email,
				"tmid" : tmid,
				"checkcode":checkcode
			},
			success : function(data) {
				if (data.status == 0) {
					alertMsg("确认成功！")
				} else {
					alertMsg(data.errmsg);
				}
			},
			error : function() {
			alertMsg(data.errmsg+'111111');
			}
		});
	}
	// 百度地图API功能
	var distance=40000;
	var map = new BMap.Map("allmap",{minZoom:3,maxZoom:18});
	map.enableScrollWheelZoom(true);
	var options = {
		enableHighAccuracy : true,
		timeout : 5000
	}
	var geolocation = new BMap.Geolocation();
	geolocation.getCurrentPosition(getSuccess, options)
	function getSuccess(r) {
		if (this.getStatus() == BMAP_STATUS_SUCCESS) {
			pointSelf = new BMap.Point(r.point.lng, r.point.lat);
			$.ajax({
				type : "POST",
				url : "../findGpsByMid",
				async : "false",
				dataType : "json",
				data : {},
				success : function(data) {
					if (data.status == 0) {
						$("#blackdiv_matchname_font").text("赛事名称："+data.mname);
						var gps = data.gps.split(",");
						pointMatch = new BMap.Point(gps[0].substring(1), gps[1].substring(0,gps[1].indexOf(")")));						  
						
						/* 点图标 */
						var matchIcon = new BMap.Icon("../images/didian.png", new BMap.Size(16,28));
						var selfIcon = new BMap.Icon("../images/dingwei.png", new BMap.Size(20,32));
						
						/* 创建赛事地点 */
						var markerMatch = new BMap.Marker(pointMatch,{icon:matchIcon}); 	
						map.addOverlay(markerMatch); 
						/* 创建确认区域地点 */
						var circle = new BMap.Circle(pointMatch,20000,{strokeColor:"blue", strokeWeight:2, strokeOpacity:0.5}); //创建圆
						map.addOverlay(circle);
						
						/* 创建定位地点 */
						var markerSelf = new BMap.Marker(pointSelf,{icon:selfIcon}); // 创建点	
						map.addOverlay(markerSelf); 
						
						/* 计算中心位置 */
						var cenLng =(parseFloat(pointMatch.lng)+parseFloat(pointSelf.lng))/2;  
        				var cenLat = (parseFloat(pointMatch.lat)+parseFloat(pointSelf.lat))/2;

						//级别18到3。
						var zoom = ["50","100","200","500","1000","2000","5000","10000","20000","25000","50000","100000","200000","500000","1000000","2000000"]
						/* 计算距离 */ 
						distance = map.getDistance(pointMatch,pointSelf).toFixed(1);
						var zoomlevel;
						for (var i = 0,zoomLen = zoom.length; i < zoomLen; i++) {  
        					if(zoom[i] - distance > 0){ 
            					zoomlevel =  18-i+1;//之所以会多3，是因为地图范围常常是比例尺距离的10倍以上。所以级别会增加3。  
        						break;
        					}  
    					};
    					map.centerAndZoom(new BMap.Point(cenLng,cenLat), zoomlevel);
						map.setMinZoom(zoomlevel);
												
					} else {
						alert(data.errmsg);
					}
					if(distance>20000){
							alert("您距离确认点还有"+distance+"米，该位置不再现场确认范围内，请到指定区域再进行现场确认！")
					}
				},
				error : function() {
				
				}
			});
		} else {
			alert('获取地理定位失败!请刷新重试！');
		}
	}
	</script>
